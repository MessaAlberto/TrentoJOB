<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html>

<script>
    import { ref, onMounted, onBeforeUnmount } from 'vue';
    import { io } from 'socket.io-client';

    export default {
        setup() {
            const user1 = localStorage.getItem("username");
            const user2 = ref('');
            const msgContent = ref('');
            const chatMessageLists = ref({});
            const socket = io('http://localhost:3000');

            socket.on("connect", () => {
                console.log("Connected to server");
            });

            socket.on("receiveMessage", (message) => {
                console.log("Message received: ", message);
                if(message.senderId !== user1){
                    if (!chatMessageLists.value[message.senderId]) {
                        const ul = document.getElementById('chatsList');
                        let li = document.createElement('li');
                        li.textContent = message.senderId;
                        ul.appendChild(li);

                        chatMessageLists.value[message.senderId] = [];
                    }
                    chatMessageLists.value[message.senderId].push(message);
                }
                else if(message.receiverId !== user1){
                    if (!chatMessageLists.value[message.receiverId]) {
                        const ul = document.getElementById('chatsList');
                        let li = document.createElement('li');
                        li.textContent = message.receiverId;
                        ul.appendChild(li);

                        chatMessageLists.value[message.receiverId] = [];
                    }
                    chatMessageLists.value[message.receiverId].push(message);
                }

                if (user2.value === message.senderId || user2.value === message.receiverId) {
                    showChatMessages();
                }
            });

            async function fetchChats() {
                try {
                    const ul = document.getElementById('chatsList');
                    const resp = await fetch(`http://localhost:3000/chats/${user1}`, {
                        method: "GET",
                        headers: { "Content-Type": "application/json" },
                    });

                    while (ul.firstChild) {
                        ul.removeChild(ul.lastChild);
                    }

                    const json = await resp.json();

                    json.forEach(chat => {
                        let li = document.createElement('li');
                        let user2Id = (chat.receiverId === user1) ? chat.senderId : chat.receiverId;
                        li.textContent = user2Id;
                        ul.appendChild(li);

                        chatMessageLists.value[user2Id] = chat.messageList;

                        socket.emit("joinRoom", { user1, user2: user2Id });
                    });
                } catch (ex) {
                    console.error(ex);
                }
            }

            function showChatMessages() {
            if (chatMessageLists.value[user2.value]) {
                const ul = document.getElementById('chat');

                while (ul.firstChild) {
                    ul.removeChild(ul.lastChild);
                }

                chatMessageLists.value[user2.value].forEach(message => {
                    let li = document.createElement('li');
                    li.textContent = message.content;
                    ul.appendChild(li);
                });
            } else {
                fetchChatMessages();
            }
            }

            async function fetchChatMessages() {
                try {
                    const ul = document.getElementById('chat');
                    const resp = await fetch(`http://localhost:3000/chats/${user1}/${user2.value}`,{
                        method: "GET",
                        headers: { "Content-Type": "application/json" },
                    });

                    const json = await resp.json();

                    while (ul.firstChild) {
                        ul.removeChild(ul.lastChild);
                    }

                    json.forEach(message => {
                        let li = document.createElement('li');
                        li.textContent = message.content;
                        ul.appendChild(li);
                        if (!chatMessageLists.value[user2.value]) {
                            chatMessageLists.value[user2.value] = [];
                        }
                        chatMessageLists.value[user2.value].push(message);
                    });

                } catch (ex) {
                    console.error(ex);
                }
            }

            async function createChat() {
                const chat_config = {
                    senderId: user1,
                    receiverId: user2.value,
                };

                try {
                    const resp = await fetch(`http://localhost:3000/chats/${user1}/addChat/${user2.value}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-Auth-Token": localStorage.getItem("token") },
                        body: JSON.stringify(chat_config),
                    });
                    const json = await resp.json();
                    console.log(json);

                    const ul = document.getElementById('chatsList');
                    let li = document.createElement('li');
                    li.textContent = chat_config.receiverId;
                    ul.appendChild(li);

                    chatMessageLists.value[chat_config.receiverId] = [];

                    socket.emit("joinRoom", { user1, user2: user2.value });
                } catch (ex) {
                    console.error(ex);
                }
            }

            async function publishMessage() {
                const message_config = {
                    senderId: user1,
                    receiverId: user2.value,
                    content: msgContent.value,
                    timestamp: new Date().toISOString()
                };

                msgContent.value = '';

                try {
                    const resp = await fetch(`http://localhost:3000/chats/${user1}/addMessage/${user2.value}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-Auth-Token": localStorage.getItem("token") },
                        body: JSON.stringify(message_config),
                    });
                    const json = await resp.json();
                    console.log(json);

                    if (!chatMessageLists.value[message_config.receiverId]) {
                        chatMessageLists.value[message_config.receiverId] = [];
                    }

                    socket.emit("sendMessage", message_config);

                } catch (ex) {
                    console.error(ex);
                }
            }


            onMounted(() => {
                fetchChats();
            });

            onBeforeUnmount(() => {
                socket.disconnect();
            });

            return {
                user1,
                user2,
                msgContent,
                chatMessageLists,
                fetchChatMessages,
                showChatMessages,
                createChat,
                publishMessage,
            };
        }
    }
</script>

<template>
    <h2 class="green">Lista chat</h2>
    <div class="UserChats">
        <li id="chatsList"></li>
    </div><br><br>

    <form class="visualizeChatForm">
        <h2 class="green">Visualizza chat</h2>
        <div class="input">
            <label class="tag" for="receiverAm">Utente:</label><br>
            <input id="receiverAm" v-model="user2" placeholder="Inserisci destinatario qui"></input>
        </div>

        <div class="buttons">
            <button class="button" type="button" @click="showChatMessages()">Visualizza chat</button>
            <button class="button" type="button" @click="createChat()">Crea chat</button>
        </div>

        <br><br>
        <div class="chatMessages">
            <li id="chat"></li>
        </div>
    </form>

    <form class="visualizeChatForm">
        <h2 class="green">Pubblica messaggio</h2>
        <div class="inputGroup">
            <div class="textarea">
                <label class="tag" for="content">contenuto:</label><br>
                <textarea id="content" v-model="msgContent" placeholder="Inserisci contenuto qui..."></textarea>
            </div>
        </div>

        <h2><button class="button" type="button" @click="publishMessage()">Pubblica messaggio</button></h2>
    </form>
</template>
<style>
    .placeholder-style::placeholder {
        color: #ccc;
    }
    h2 {
        font-weight: 500;
        font-size: 2.0rem;
        padding: 10px;
        margin-bottom: 10px;
    }
    .visualizeChatForm {
        border-radius: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        outline: none;
        width: 350px;
        margin-top: 15px;
        border-radius: 20px;
    }
    .buttons {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }
    .button {
        flex: 1;
        font-size: 1.2rem;
        width: 130px;
        height: auto;
        border-radius: 20px;
        border: none;
        margin-left: 15px;
        padding: 10px;
        outline: none;
        background-color: hsla(160, 100%, 37%, 1);
        color: white;
        cursor: pointer;
    }
    .button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .inputGroup {
        text-align: left;
        margin-top: 15px;
    }
    .visualizeChatForm .tag {
        font-weight: 500;
        display: inline-block;
        width: 90px;
        margin-bottom: 5px;
        color: white;
    }
    .visualizeChatForm input,
    .visualizeChatForm select,
    .visualizeChatForm textarea {
        width: 200px;
        height: 40px;
        margin-bottom: 15px;
        margin-top: 15px;
        border-radius: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        outline: none;
    }
    .visualizeChatForm textarea {
        width: 300px;
        height: 100px;
    }
</style>